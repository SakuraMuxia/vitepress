# 会话控制

## 会话控制介绍

HTTP 协议是一个无状态的协议，它无法区分多次请求是否发送自同一客户端，而我们在实际的使用中，却又大量需要这种需求，我们需要通过会话的控制来解决该问题。

常见的会话控制解决方案有 ：

* cookie
* session
* token

## cookie

### cookie 实现原理

cookie本质是一个存储在浏览器的文本，随着http请求自动传递给服务器。

- 服务器以响应头的形式将如何设置 cookie 发送给浏览器。
- 浏览器收到以后会设置 cookie 并保存。
- 浏览器再次访问服务器时，会以请求头的形式将 cookie 发送。
- 服务器就可以通过检查浏览器发送的 cookie 来识别出不同的浏览器。 

### cookie 使用演示

在 express 中，通过配置 `cookie-parser` 中间件，可以将 `cookie` 解析为一个对象，并为 `request` 对象添加了一些操作 cookie 属性方法。

**安装：**

```bash
npm install cookie-parser
```

**引入：**

```js
const cookieParser = require("cookie-parser");
```

**挂载中间件：**

```js
app.use(cookieParser());
```

**使用：**

```js
// 设置 cookie （添加或修改） 注意：cookie的属性设置使用小驼峰
res.cookie("userName","laoli");
res.cookie("age",18,{maxAge:20*1000});  // maxAge 单位是毫秒

// 读取 cookie 
req.cookies;  

// 删除 cookie
res.clearCookie("userName");
res.clearCookie("age",{path:"/login"});
```

### cookie 的缺点

1）各个浏览器对 cookie 的数量和大小都有不同的限制，这样就导致我们不能在 cookie 中保存过多的信息。一般数量不超过 50 个，单个大小不超过 4kb。

2）cookie 如何设置是由服务器发送给浏览器，再由浏览器将 cookie内容发回，如果 cookie 较大会导致发送速度非常慢，降低用户的体验。

3)   cookie 内容存储在客户端浏览器，客户端可以对 cookie 内容进行修改，安全性低。

## session

### session 实现原理

Session 是一个对象，存储特定用户会话所需的属性及配置信息。Session是保存在服务器端的数据，保存介质可以是文件、数据库或者内存。

**session 运行原理：**

```
1. 服务器中为每一次会话创建一个对象，然后每个对象都设置一个唯一的 ID。
2. 通过设置响应头让浏览器设置 cookie 用于保存该 ID。
3. 将会话中产生的数据统一保存到 session 对象中，这样我们就可以将用户的数据全都保存到服务器中，而不需要保存到客户端，客户端只需要保存一个 ID 即可。
```

### session 使用演示

在 express 中，通过配置 `express-session` 中间件，可以将 `cookie` 解析为一个对象，并为 `request` 对象添加了一些操作 cookie 属性方法。

**安装：**

```bash
npm install express-session
```

**引入：**

```js
var session = require("express-session");
```

**挂载中间件：**

```js
app.use(session({
    name: 'sess',      // 设置cookie的name，默认值是：connect.sid
    secret: 'atguigu', // 参与加密的字符串（又称签名）
    saveUninitialized: false, //是否为每次请求都设置一个 cookie 用来存储 session 的 id
    resave: false ,// 强制保存 session 即使它并没有变化, 默认为 true,建议设置成 false。
    cookie: {
    	httpOnly: true, // 开启后前端无法通过 JS 操作
        maxAge: 1000*30 // 这一条 是控制 sessionID 的过期时间的！！！
    }
}));
```

**使用：**

```js
app.get("/setSession",function (req,res){
    req.session.userName = "zhangsan";
    res.send("设置成功");
})
app.get("/getSession",function (req,res){
    console.log(req.session.userName)
    res.send("获取成功")
})
app.get("/delSession",function (req,res){
    req.session.destroy(function (){
       res.send("删除成功");
    })
})
```

### cookie 和 session 的区别

**1）存储位置：**

- cookie 存储于客户端浏览器。
- session 存储于服务器端（存储介质可以是文件、内存、数据库等），一个 session 对象为一个用户浏览器服务。

**2）安全性：**

- cookie 是以明文的方式存放在客户端的，安全性较低，可以通过一个加密算法进行加密后存放。
- session 存放于服务器中，所以安全性较好。

**3） 网络传输量：**

- cookie ，浏览器每次发起请求，都会将该网站的所有cookie放进请求头。
- session 本身存放于服务器，浏览器 cookie 中只存储 ID，只有少量的传送流量。

**4）大小：**

- cookie 保存的数据不能超过4K，很多浏览器都限制一个站点最多保存50个cookie。
- session 保存数据理论上没有任何限制。

## 记账本注册登录功能

```js
1. 用户路由
   ① 注册页面
     GET 	/users/reg
   ② 执行注册
	 POST  /users/reg
   ③ 登录页面
     GET   /users/login
   ③ 执行登录
     POST /users/login
   ④ 退出登录
     GET /users/logout
     
2. 注册用户
   数据库创建 users 集合，创建对应的 schema、model
   将用户信息添加到集合中
   用户名是唯一的，否则无法注册成功
   密码经过md5加密之后存储在数据库
   
3. 登录
   根据提交的用户名和密码从数据库查找，如果找到说明存在用户，登录成功，如果找不到，登录失败
   登录成功之后，将用户信息存储在 session 中
   
   
   
4. 全局登录验证
   有些页面只有登录之后才能访问，如果没有登录，跳转到登录页
   哪些必须登录之后才允许访问   
   		GET /account
   		GET /account/create
   		POST /account/create           在account路由前面加中间件如果有session信息执行next（）
   		GET /account/delete/:id		    没有的话重定向。  
   		
  
   哪些不需登录就可以访问
   		GET  /users/reg
   		POST  /users/reg
   		GET   /users/login
    	POST /users/login
    	GET /users/logout
    	
    	
    如何验证是否登录？ 看能否获取到session
    将用户信息显示在账单首页上

5. 退出登录
	销毁session
   
   
6. 账单
   账单集合，每个文档添加一个属性，记录用户id
   添加账单的时候，将用户id添加进去
   查询账单查询只查询该用户的账单

```

