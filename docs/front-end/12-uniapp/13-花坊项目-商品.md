# 花坊项目商品详情

## 商品详情

**思路**

商品详情页面

```ts
搭建商品详情静态页面 
    pages/goodsDetail/goodsDetail.wxml 
    pages/goodsDetail/goodsDetail.js 
    pages/goodsDetail/goodsDetail.wxss 
    pages/goodsDetail/goodsDetail.json 

card组件中设置方法 
methods:{
    // 点击获取商品的详情页面 
    getDetail(event){ 
        // 获取商品id
        event....id
        // 路由跳转
        微信小程序中的路由没有 params ,只有query
        query: /pages/goodsDetails/goodsDetails?goodsId=${goodsId}
        params: /pages/goodsDetails/goodsDetails/1/2 (微信小程序没有这种写法)
    }
}

修改商品详情的标题 json文件

商品路由跳转
编程时导航	wx.switchTab() 跳转到tabbar页面
声明式导航	navigate 的 open-type = "reLaunch" 默认是navigate 不能跳转到 tabbar

祝福语弹窗区域 使用vant组件库中sheet组件

card组件使用自定义属性设置id

封装获取商品详情的接口api 参数[goodsId]

定义获取商品详情的函数，函数中发送请求

商品详情onLoad时获取数据
onLoad(option){
    option 获取商品的goodsId
    存储 商品goodsID 
    调用 获取商品详情 函数
    存储 商品详情 数据
}

渲染商品详情页面数据

商品详情动作面板的显示与隐藏
van-action-sheet组件 show属性 show="{{showSheet}}" 控制显示与隐藏
van-action-sheet组件 bind:click-overlay="{{overplay}}"事件 点击其他区域隐藏动作面板
加入购物车按钮 绑定单击事件 bind:tap="addCart" 
	修改showSheet数据状态 
渲染动作面板的数据

立即购买按钮 绑定单击事件 bind:tap="buynow" 
	修改showSheet数据状态 
    
定义 overplay 函数
	点击遮罩层后侧，关闭弹窗显示
	修改showSheet数据状态,关闭动作面板,清空type数据状态

加入购物车和立即购买 显示和隐藏 购买数量
	定义一个数据状态type:"",用于区分 加入购物车 和 立即购买
    点击加入购物车时,修改type数据状态
	点击立即购买时,修改type数据状态
	使用wx:if 控制计数条的显示与隐藏

定义数据状态 skuNum:1 收集计数器商品数量(默认是1)
在 计数器 组件上 通过 bind:change = "changenum" 事件的回调函数中的参数[event] event.detail 获取当前输入的值
定义 计数器的回调函数 获取当前计数器的值
changenum(event){
    event.detail() // 获取当前计数器最新的值
    存储商品的数量
}

定义数据状态 祝福语 remark:''
在textarea组件中设置 model:value={{}} 设置双向绑定获取祝福语

封装 加入购物车 接口api 参数[商品id,商品数量,祝福语]


在确定按钮 绑定单击事件 bind:tap="confim" 
confim(){
    区分是加入购物车还是立即购买,通过type区分
    如果是加入购物车,调用 加入购物车函数 addGoodsToCart()
    如果是立即购买,调用 立即购买函数 buyImmediate
}

定义 加入购物车 函数 addGoodsToCart(){}
    addGoodsToCart(){
        未登录时(通过是否存在token),跳转到登陆页面,提示信息 跳转到编辑页面，
        编辑页面点击确定后,登陆成功
        登录后，返回到商品页面
        登录后,执行下边逻辑
        // 判断是否 填写了 祝福语
            有,放行
            没有,使用vant中的toast组件 做信息提示
            toast组件是 js 代码,同时也需要在 wxml页面引入 van-toast组件标签
            (任何位置都可以,一般放在最后)
        // 整理参数
        // 发请求
        // 关闭动作面板,清空 计数器数量 和 祝福语
        加入购物车成功 提示信息(选)

    }

购物车页面结算按钮 和 商品详情页面立即购买按钮 都可以跳转到订单详情页面
定义 立即购买 函数 buyImmediate
	buyImmediate(){
        解构 商品id 和 祝福语
        路由跳转到订单页面order,同时传递 商品id 和 祝福语,通过query的方式传递参数
        清空 商品id 和 祝福语 数据
    }

```

购物车页面

```ts
购物车页面结算按钮 和 商品详情页面立即购买按钮 都可以跳转到订单详情页面

购物车页面结算按钮 绑定单击事件 bind:tap="goOrder"
    goOrder(){
        // 路由跳转到订单详情页面
    }
```

订单详情页面

```ts
新建 订单详情页面 order,静态页面

修改订单详情页面标题
订单详情页面静态搭建
van-field组件：表单输入框
van-cell组件：单元格,绑定单击事件, is-Link 属性,use-label-slot使用插槽
van-popup组件：日期选择卡,
van-Datetimepicker组件：日历选项卡

订单详情页面的onLoad(options){} options参数中获取 query 参数

封装 获取订单详情数据(通过立即购买按钮跳转) 接口 参数[goodsId,祝福语]
export const reqBuyNowGoodsInfo = () =>{
    
}

订单详情页面定义 商品id 和祝福语数据状态

订单详情页面的options参数中获取 query 参数
通过options参数中的数据判断是从 立即购买按钮 来的还是从 购物车结算按钮 来的
onLoad(options){
    如果options.remarks存在,代表是从立即购买按钮来的
    存储 商品id和祝福语
    调用 发送获取立即购买商品信息
}


定义 获取订单详情数据 函数(通过立即购买确定按钮来的) getOrderListByImme(){}
getOrderListByImme(){
    获取 商品id和 祝福语 参数
    调用 获取立即购买商品id 的接口[需要商品id和祝福语]
    获取 立即购买商品信息 存储商品数据,同时渲染数据
    
}

定义 获取订单详情数据 函数(通过购物车结算按钮来的) getOrderListBySettle(){}
getOrderListBySettle(){
    发送获取购物车数据请求
    存储购物车商品数据 cartList:[]
    订单页面渲染购物车商品数据
    调用计算商品总价函数
}

定义购物车商品总价 totalPrice,渲染总价数据

定义计算商品总价的函数 computedTotal(){
    使用数组的 reduce方法计算购物车的总价
    更新totalPrice数据状态
}

在van-cell标签上绑定单击事件showPop,同时定义数据状态isShowPopup,用于控制popup组件显示与隐藏
定义 showPop 函数,修改isShowPopup数据状态,控制popUp组件的显示与隐藏

在van-popup标签上绑定单击事件bind:click-overlay="close",控制popup组件的隐藏

在van-datetime-picker标签上绑定事件bind:cancel="close",控制popup组件隐藏
在van-datetime-picker标签上绑定事件bind:confirm="confirm",收集确定的事件
在van-datetime-picker设置 min-date属性控制最小的时间,同时定义数据状态获取当前的时间

定义 close 函数,设置数据状态isShowPopup
定义 confirm 函数,获取确定的事件参数是event对象 event.detail代表当前时间戳
	通过moment插件将时间戳转为年月日格式,并存储
	关闭popup组件显示
    
渲染日期数据

通过moments或datejs将时间戳转为年月日
import moment from 'moment'
moment(时间戳).format('YYYY-MM-DD')

包报错,把构建后的文件夹删除,把node-models文件夹删除,然后重新安装包,重新构建就可以了

```

订单收货人部分

```ts
封装 获取订单收货人地址接口 参数[token] 

在订单详情页面的 onLoad(){} 中定义调用 订单收货人地址 函数 getAddress(){}
函数中发送 获取订单收货人地址 接口 
定义收货人地址 数据状态
渲染订单页面 收货人数据
```

微信支付流程

```ts
文档地址：API-支付
wx.requestPayment(object)
参数：object

支付流程：开发指引-左侧开发指引

微信鉴权：微信平台做的处理，有没有开通网上银行，余额

封装提交订单的接口 获取订单编号 参数[请求体]
	请求地址
	请求方法
	收货人的id
    订购人的姓名
    订购人手机号
    商品列表
    收货日期
    

```

订单详情页面

```ts
订单详情页面的结算按钮绑定单击事件 submitOrder(){}

定义结算按钮提交订单函数 获取订单号 submitOrder(){}
submitOrder(){
    收集参数
    发送请求,获取数据result
    如果result数据存在,则调用 获取支付参数信息 函数,获取支付参数信息
}

收集 结算按钮提交订单函数 参数 const data={}
	定义 订购人姓名数据状态同时使用 model:value双向绑定
    定义 订购人手机号同时使用 model:value双向绑定
    定义 期望送达日期 通过confim函数收集
    祝福语同时使用 model:value双向绑定
    商品数组 数据状态已经存储了
    
wx.requestPayment({})

根据订单号,获取支付参数信息
封装 获取支付参数信息 接口 参数[订单号]

定义 获取支付参数信息 函数 参数[订单号]
	发送 获取支付参数信息 请求,获取支付参数数据 result
    如果 result.code === 200 发起微信支付
    wx.requestPayment(object)
支付成功的回调
	success(){
        查询支付状态(真实情况),调用 查询支付状态 接口
        如果响应的状态是成功的
        	跳转到支付成功页面
           	新建一个支付成功页面
                支付成功页面放一个图片和一个按钮,按钮跳转首页,使用wx.reLaunch方法跳转到tabBar首页
            
       
    }
封装 查询支付状态 接口 参数[订单号] 返回订单的支付状态(向后台发送请求)
```

微信小程序支付流程

![image-20241125164914359](https://2216847528.oss-cn-beijing.aliyuncs.com/asset/image-20241125164914359.png)



## 地址页面

订单详情页面

```ts
默认地址和添加收货人 使用wx:if控制显示和隐藏,通过userInfo.name不存在,则显示添加,否则显示默认地址

添加收货人
	跳转到地址列表页面
```

地址列表页面

```ts
渲染静态页面和样式
```

新增地址页面

```ts

```

